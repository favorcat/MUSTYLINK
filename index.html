<div class="wrapper">
    <div class="container mt-5 pt-5">
        <div class="row">
            <div class="col-sm-4"></div>
            <div class="col-sm-4">
                <form action="">
                    <div class="avatar-upload">
                        <div class="avatar-preview">
                            <div>
                                <button class="btn" type="button" onclick="removeImgSrc(this)" id="removeBtn" style="display: none;">x</button>
                                <img src="" id="imagePreview" alt="">
                                <div class="text-danger small" id="maxAlert"></div>
                                <div id="fileinfo">
                                    <div id="filename"></div>
                                    <div id="fileSize"></div>
                                    <div id="fileMemorySize"></div>
                                </div>
                            </div>
                        </div>
                        <div class="avatar-edit text-center" id="avatar-edit">
                            <input type='file' id="imageUpload" accept=".png, .jpeg, .jpg" onchange="changePreview(this)" name="imagename" />
                            <label for="imageUpload"> 업로드해서 예측하기  <small>(Max 600KB)</small></label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="label-container"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script>
    function changePreview(path) {
        let imagePreview = getID("imagePreview");
        let maxImgSize = 1024 * 600;
        if (path.files && path.files[0]) {
            if (path.files[0].size < maxImgSize) {
                //alert(maxImgSize + " - " + path.files[0].size);
                let reader = new FileReader();
                reader.onload = function(b) {
                    imagePreview.src = b.target.result;
                    //alert(imagePreview.src);
                    getID("filename").innerHTML = path.files[0].name;
                    getID("fileMemorySize").innerHTML = bytesToSize(path.files[0].size);
                    getID("maxAlert").innerHTML = "";
                };
                reader.readAsDataURL(path.files[0]);
                getID("removeBtn").style.display = "block";
                getID("fileinfo").style.display = "block";
                getID("avatar-edit").style.display = "none";
            } else {
                //alert("Large file size");
                getID("maxAlert").innerHTML =bytesToSize(path.files[0].size) + " Not allowed";
            }
        }
    }

    // remove image src onclick
    function removeImgSrc(btn) {
        getID("imagePreview").style.display = "none";
        getID("imageUpload").value = getID("imagePreview").src = getID("filename").innerHTML = getID("fileSize").innerHTML = getID("fileMemorySize").innerHTML = "";
        getID("avatar-edit").style.display = "block";
        getID("fileinfo").style.display = "none";
        btn.style.display = "none";
        getID("label-container").style.display = "none";
        }

    function getID(id) {
        return document.getElementById(id);
    }
</script>

<script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/HPPjII80T/";

    let model, webcam, labelContainer, maxPredictions;

    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        labelContainer = document.getElementById("label-container");
    }

    async function predict() {
        var image = document.getElementById('imagePreview');
        const prediction = await model.predict(image, false);
        const arr = [];
        arr.length = maxPredictions;
        for (let i = 0; i < maxPredictions; i++) {
            arr[i] = prediction[i].probability.toFixed(2) * 100;
        }
        idx = arr.indexOf(Math.max.apply(null,arr));
        labelContainer.innerHTML = prediction[idx].className;
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script type="text/javascript">
    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#imagePreview').attr('src', e.target.result);
                // $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
                $('#imagePreview').hide();
                $('#imagePreview').fadeIn(650);
            };
            reader.readAsDataURL(input.files[0]);
            init().then(() => {
                predict();
            });
        }
    }
    $('#imageUpload').change(function () {
        readURL(this);
    });
</script>

<style>
    .wrapper{
        display:flex;
        flex-direction: column;
        padding: 5%;
        padding-left: 10%;
        padding-right: 10%;
    }
    #label-container{
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    #imagePreview{
        display:none;
    }
    .avatar-upload {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
    }
    .avatar-upload .avatar-edit {
        right: 12px;
        z-index: 1;
        top: 10px;
    }
    .avatar-upload .avatar-edit input {
        display: none;
    }
    .avatar-upload .avatar-edit input + label {
        display: block;
        margin-bottom: 0;
        background: #f8f9fa;
        cursor: pointer;
        font-weight: normal;
        transition: all 0.2s ease-in-out;
        padding: 10px 15px;
    }
    .avatar-upload .avatar-edit input + label:hover {
        background: #eafffd;
    }
    #fileinfo{
        display: none;
        background: #ffffffc9;
        bottom: 10%;
        left: 5%;
        width: 90%;
        padding: 5px 10px;
    }
    #removeBtn {
        margin-left: 99%;
        margin-bottom: 20px;
        border-radius: 50%;
        height: 28px;
        width: 28px;
        line-height: 1;
        display: none;
        background: rgba(255, 255, 255, 0.85);
        color: #000;
    }

    #label-container {
        font-size: x-large;
    }
</style>